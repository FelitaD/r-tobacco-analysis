---
title: "R Notebook"
output: html_notebook
---
```{r}
library(tidyverse)
library(scales)
library("reshape2")
library("ggplot2")
library(xts)
library(zoo)
library(tsbox)
```

```{r}
  data <- read.csv("~/CNAM/Stats/Mini-memoire/data/data.csv")
```

#### Choix des variables

```{r}
    data_subset <- select(data, IDATE, IYEAR, IMONTH,  X_RFSMOK3, ADDEPEV2, POORHLTH, MENTHLTH)
    data_subset <- data_subset[!is.na(data_subset$IDATE), ]

    data_subset <- data_subset  %>%
                    mutate(X_RFSMOK3 = ifelse(X_RFSMOK3 == "true", 1, 0)) 
    
    data_subset <- drop_na(data_subset) 
```

#### Choix du type d'aggregation 

- Aggregation par jour
```{r}
    agg_day <- data_subset  %>%
                    filter(IYEAR != 2020) %>%
                    group_by(IDATE) %>% 
                    summarize(ADDEPEV2 = mean(ADDEPEV2),
                            POORHLTH = mean(POORHLTH),
                            MENTHLTH = mean(MENTHLTH),
                            X_RFSMOK3 = mean(X_RFSMOK3)) 
      
    agg_day$IDATE <- as.Date(agg_day$IDATE, format="%Y-%m-%d")
```

- Aggregation par mois
```{r}
    agg_year <- data_subset  %>%
                    filter(IYEAR != 2020) %>%
                    group_by(IMONTH) %>% 
                    summarize(ADDEPEV2 = mean(ADDEPEV2),
                            POORHLTH = mean(POORHLTH),
                            MENTHLTH = mean(MENTHLTH),
                            X_RFSMOK3 = mean(X_RFSMOK3)) 
      
    agg_year$IYEAR <- as.Date(agg_year$IYEAR, format="%Y-%m-%d")
```

- Aggregation par annee
```{r}
    agg_year <- data_subset  %>%
                    filter(IYEAR != 2020) %>%
                    group_by(IYEAR) %>% 
                    summarize(ADDEPEV2 = mean(ADDEPEV2),
                            POORHLTH = mean(POORHLTH),
                            MENTHLTH = mean(MENTHLTH),
                            X_RFSMOK3 = mean(X_RFSMOK3)) 
      
    agg_year$IYEAR <- as.Date(agg_year$IYEAR, format="%Y-%m-%d")
```

## Creation des Time Series

- Par jour
```{r}
  data_date <- agg_day$IDATE
  agg_day <- agg_day %>% select(-IDATE)
  ts <- xts(agg_day, data_date) 
  plot(ts)
```

```{r}
  smokers_mentalhealth <- ts_ts(ts)
  print(smokers_mentalhealth)
  plot(smokers_mentalhealth)
  colnames(smokers_mentalhealth)
```

- Par annee
```{r}
  data_date <- agg_day$IYEAR
  agg_day <- agg_day %>% select(-IDATE)
  ts <- xts(data, agg_day) 
  plot(ts)
```

```{r}
  smokers_mentalhealth <- ts_ts(ts)
  print(smokers_mentalhealth)
  plot(smokers_mentalhealth)
  colnames(smokers_mentalhealth)
```


#### DIVISION EN TIMES SERIES UNIVARIES

```{r}
  smokers_ts <- smokers_mentalhealth[, 'X_RFSMOK3']
  depress_ts <- smokers_mentalhealth[, 'ADDEPEV2']
  poor_phys_mental_ts <- smokers_mentalhealth[, 'POORHLTH']
  poor_mental_ts <- smokers_mentalhealth[, 'MENTHLTH']
  ts.plot(smokers_ts)
  ts.plot(depress_ts)
  ts.plot(poor_phys_mental_ts)
  ts.plot(poor_mental_ts)
```

 <!-- Ressemble a du white noise : mean and variance constante, pas de correlations over time (pas de seasonal trends) -->
 <!-- Bemol quand meme perdiodicite cycle d'un an (du au fetes moins d'interviews)  -->

## WHITE NOISE MODEL - POOR MENTAL HEALTH

```{r}
ts.plot(poor_mental_ts)
poor_mental_ts_diff <- diff(poor_mental_ts, lag = 4) # remove long term (seasonal) trends
ts.plot(poor_mental_ts_diff)
```

Base pour d'autres modeles de time series

ARIMA(p, d, q)
- auto-regressive p
- order of integration (differencing) d
- moving average order q

#### Estimation

```{r}
arima(poor_mental_ts_diff, order=c(0, 0, 0))
```
```{r}
lapply(poor_mental_ts_diff, mean, na.rm = TRUE)
lapply(poor_mental_ts_diff, var, na.rm = TRUE)
```
> La comparaison de la moyenne et de la variance est quasi-identique


















```{r}
    d <- select(data, IYEAR, X_RFSMOK3, ADDEPEV2, POORHLTH, MENTHLTH)
    # Creation d'une variable contenant une valeur unique
    e <- d  %>%
      mutate(X_RFSMOK3 = ifelse(X_RFSMOK3 == "true", 1, 0)) 
    e <- drop_na(e)
    f <- e %>%
    filter(IYEAR != 2020) %>%
    group_by(IYEAR) %>% 
    summarize(ADDEPEV2 = sum(ADDEPEV2),
              POORHLTH = mean(POORHLTH),
              MENTHLTH = mean(MENTHLTH),
              X_RFSMOK3 = sum(X_RFSMOK3))
```

```{r}
  data_date <- agg_day$IDATE
  agg_day <- agg_day %>% select(-IDATE)
  ts <- xts(data, agg_day) 
  plot(ts)
  a <- xts(f)

```

```{r}
print(a)
start(a)
end(a)
frequency(a)
deltat(a)
plot(a)
```

```{r}
n <- colnames(a)
```

```{r}
  ts.plot(a, col = 2:3, xlab = "Year", ylab = "Nombre de jours", main = "tobacco and mental heath")

# Add a legend to your ts.plot
  legend("topleft", n[2:3], lty = 1, col = 2:3, bty = "n")
```

